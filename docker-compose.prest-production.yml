# =============================================================================
# AgentStack OSS - Production-Grade pREST API Configuration
# Version: 2.0.0
# Description: Enterprise-grade pREST REST API with advanced security, monitoring
# =============================================================================
# Usage: docker-compose -f docker-compose.prest-production.yml up -d
# Dashboard URLs:
#   - pREST API: https://api.agentstack.local:3000
#   - Traefik Dashboard: https://traefik.agentstack.local:8080
#   - Prometheus: https://prometheus.agentstack.local:9090
#   - Grafana: https://grafana.agentstack.local:3001
#   - Jaeger: https://jaeger.agentstack.local:16686
# =============================================================================

version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # 1. DATABASE: PostgreSQL with PgBouncer Connection Pooling
  # ---------------------------------------------------------------------------
  postgres:
    image: pgvector/pgvector:pg17-0.8.0
    container_name: agentstack-postgres-prod
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-agentstack}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C --data-checksums"
      # Performance tuning
      POSTGRES_SHARED_BUFFERS: ${POSTGRES_SHARED_BUFFERS:-256MB}
      POSTGRES_WORK_MEM: ${POSTGRES_WORK_MEM:-16MB}
      POSTGRES_MAINTENANCE_WORK_MEM: ${POSTGRES_MAINTENANCE_WORK_MEM:-128MB}
      POSTGRES_EFFECTIVE_CACHE_SIZE: ${POSTGRES_EFFECTIVE_CACHE_SIZE:-1GB}
      POSTGRES_MAX_CONNECTIONS: ${POSTGRES_MAX_CONNECTIONS:-200}
      # SSL and security
      POSTGRES_SSL: ${POSTGRES_SSL:-on}
      POSTGRES_HOST_AUTH_METHOD: ${POSTGRES_HOST_AUTH_METHOD:-scram-sha-256}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - postgres_ssl:/opt/agentstack/postgres/ssl
      - ./init/postgres:/docker-entrypoint-initdb.d:ro
      - ./config/postgres/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./config/postgres/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-agentstack} -h localhost"]
      interval: ${HEALTH_CHECK_INTERVAL:-30}s
      timeout: ${HEALTH_CHECK_TIMEOUT:-10}s
      retries: ${HEALTH_CHECK_RETRIES:-3}
      start_period: 60s
    networks:
      - agentstack-backend
      - agentstack-monitoring
    deploy:
      resources:
        limits:
          cpus: ${POSTGRES_CPU_LIMIT:-2}
          memory: ${POSTGRES_MEMORY_LIMIT:-2G}
        reservations:
          cpus: ${POSTGRES_CPU_RESERVATION:-1}
          memory: ${POSTGRES_MEMORY_RESERVATION:-1G}
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # ---------------------------------------------------------------------------
  # 2. PgBouncer: Connection Pooling
  # ---------------------------------------------------------------------------
  pgbouncer:
    image: pgbouncer/pgbouncer:latest
    container_name: agentstack-pgbouncer-prod
    restart: unless-stopped
    environment:
      DATABASES_HOST: postgres
      DATABASES_PORT: 5432
      DATABASES_USER: ${POSTGRES_USER:-postgres}
      DATABASES_PASSWORD: ${POSTGRES_PASSWORD}
      DATABASES_DBNAME: ${POSTGRES_DB:-agentstack}
      POOL_MODE: ${PGBOUNCER_POOL_MODE:-transaction}
      MAX_CLIENT_CONN: ${PGBOUNCER_MAX_CLIENT_CONN:-200}
      DEFAULT_POOL_SIZE: ${PGBOUNCER_DEFAULT_POOL_SIZE:-20}
      MIN_POOL_SIZE: ${PGBOUNCER_MIN_POOL_SIZE:-5}
      RESERVE_POOL_SIZE: ${PGBOUNCER_RESERVE_POOL_SIZE:-5}
      RESERVE_POOL_TIMEOUT: ${PGBOUNCER_RESERVE_POOL_TIMEOUT:-5}
      SERVER_RESET_QUERY: ${PGBOUNCER_SERVER_RESET_QUERY:-DISCARD ALL}
      SERVER_CHECK_DELAY: ${PGBOUNCER_SERVER_CHECK_DELAY:-30}
      SERVER_LIFETIME: ${PGBOUNCER_SERVER_LIFETIME:-3600}
      SERVER_IDLE_TIMEOUT: ${PGBOUNCER_SERVER_IDLE_TIMEOUT:-600}
      # TLS
      SERVER_SSL_MODE: ${PGBOUNCER_SERVER_SSL_MODE:-require}
      CLIENT_SSL_MODE: ${PGBOUNCER_CLIENT_SSL_MODE:-require}
    volumes:
      - ./config/pgbouncer/pgbouncer.ini:/etc/pgbouncer/pgbouncer.ini:ro
      - ./config/pgbouncer/userlist.txt:/etc/pgbouncer/userlist.txt:ro
      - postgres_ssl:/opt/agentstack/postgres/ssl:ro
    ports:
      - "${PGBOUNCER_PORT:-6432}:6432"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - agentstack-backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -h localhost -p 6432"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: ${PGBOUNCER_CPU_LIMIT:-0.5}
          memory: ${PGBOUNCER_MEMORY_LIMIT:-512M}
        reservations:
          cpus: ${PGBOUNCER_CPU_RESERVATION:-0.25}
          memory: ${PGBOUNCER_MEMORY_RESERVATION:-256M}

  # ---------------------------------------------------------------------------
  # 3. pREST API: Production REST API Service
  # ---------------------------------------------------------------------------
  prest-api:
    image: prest/prest:v2.0.0
    container_name: agentstack-prest-prod
    restart: unless-stopped
    environment:
      # Database connection (via PgBouncer)
      PREST_PG_HOST: pgbouncer
      PREST_PG_PORT: 6432
      PREST_PG_USER: ${POSTGRES_USER:-postgres}
      PREST_PG_PASS: ${POSTGRES_PASSWORD}
      PREST_PG_DATABASE: ${POSTGRES_DB:-agentstack}
      PREST_SSL_MODE: ${PREST_SSL_MODE:-require}
      PREST_SSL_CERT: /opt/agentstack/prest/ssl/client.crt
      PREST_SSL_KEY: /opt/agentstack/prest/ssl/client.key
      PREST_SSL_CA: /opt/agentstack/prest/ssl/ca.crt

      # Authentication and Authorization
      PREST_AUTH_ENABLED: ${PREST_AUTH_ENABLED:-true}
      PREST_AUTH_TYPE: ${PREST_AUTH_TYPE:-jwt}
      PREST_JWT_KEY: ${JWT_SECRET}
      PREST_JWT_ALGO: ${PREST_JWT_ALGO:-HS256}
      PREST_JWT_EXCLUDE: ${PREST_JWT_EXCLUDE:-/health,/metrics}

      # Security headers
      PREST_CORS_ALLOW_ORIGIN: ${PREST_CORS_ALLOW_ORIGIN:-https://agentstack.local}
      PREST_CORS_ALLOW_METHODS: ${PREST_CORS_ALLOW_METHODS:-GET,POST,PUT,DELETE,OPTIONS}
      PREST_CORS_ALLOW_HEADERS: ${PREST_CORS_ALLOW_HEADERS:-Authorization,Content-Type,X-Requested-With}
      PREST_CORS_ALLOW_CREDENTIALS: ${PREST_CORS_ALLOW_CREDENTIALS:-true}
      PREST_SECURITY_HEADERS: ${PREST_SECURITY_HEADERS:-true}
      PREST_RATE_LIMIT: ${PREST_RATE_LIMIT:-1000}
      PREST_RATE_LIMIT_WINDOW: ${PREST_RATE_LIMIT_WINDOW:-3600}

      # Performance tuning
      PREST_DEBUG: ${PREST_DEBUG:-false}
      PREST_CACHE_ENABLED: ${PREST_CACHE_ENABLED:-true}
      PREST_CACHE_TIME: ${PREST_CACHE_TIME:-300}
      PREST_CACHE_MIDDLEWARE: ${PREST_CACHE_MIDDLEWARE:-memory}
      PREST_MAX_OPEN_CONN: ${PREST_MAX_OPEN_CONN:-25}
      PREST_MAX_IDLE_CONN: ${PREST_MAX_IDLE_CONN:-5}
      PREST_CONN_MAX_LIFETIME: ${PREST_CONN_MAX_LIFETIME:-300}

      # Query restrictions
      PREST_QUERY_LIMIT: ${PREST_QUERY_LIMIT:-1000}
      PREST_QUERY_TIMEOUT: ${PREST_QUERY_TIMEOUT:-30}
      PREST_BATCH_SIZE: ${PREST_BATCH_SIZE:-100}
      PREST_ENABLE_SINGLE_PARTITION: ${PREST_ENABLE_SINGLE_PARTITION:-true}

      # Schema and table access
      PREST_SCHEMA: ${PREST_SCHEMA:-public}
      PREST_EXCLUDED_TABLES: ${PREST_EXCLUDED_TABLES:-secrets,tokens,sessions}
      PREST_READ_ONLY_TABLES: ${PREST_READ_ONLY_TABLES:-audit_logs,system_configs}

      # Monitoring and observability
      PREST_METRICS_ENABLED: ${PREST_METRICS_ENABLED:-true}
      PREST_METRICS_PATH: ${PREST_METRICS_PATH:-/metrics}
      PREST_REQUEST_LOG: ${PREST_REQUEST_LOG:-true}
      PREST_SLOW_QUERY_THRESHOLD: ${PREST_SLOW_QUERY_THRESHOLD:-1000}

      # OpenTelemetry
      OTEL_ENABLED: ${OTEL_ENABLED:-true}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://jaeger:4317}
      OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME:-agentstack-prest-api}
      OTEL_RESOURCE_ATTRIBUTES: ${OTEL_RESOURCE_ATTRIBUTES:-service.version=2.0.0}

      # Plugin system
      PREST_PLUGINS_ENABLED: ${PREST_PLUGINS_ENABLED:-true}
      PREST_PLUGINS_PATH: ${PREST_PLUGINS_PATH:-/opt/agentstack/prest/plugins}

      # API Documentation
      PREST_DOCS_ENABLED: ${PREST_DOCS_ENABLED:-true}
      PREST_DOCS_PATH: ${PREST_DOCS_PATH:-/docs}

      # Health check endpoints
      PREST_HEALTH_ENABLED: ${PREST_HEALTH_ENABLED:-true}
      PREST_HEALTH_PATH: ${PREST_HEALTH_PATH:-/health}
    volumes:
      - ./config/prest/prest.toml:/etc/prest/prest.toml:ro
      - ./config/prest/plugins:/opt/agentstack/prest/plugins:ro
      - postgres_ssl:/opt/agentstack/prest/ssl:ro
      - prest_logs:/var/log/prest
    depends_on:
      pgbouncer:
        condition: service_healthy
    networks:
      - agentstack-backend
      - agentstack-frontend
      - agentstack-monitoring
    healthcheck:
      test: ["CMD-SHELL", "curl -f -k https://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      replicas: ${PREST_REPLICAS:-2}
      resources:
        limits:
          cpus: ${PREST_CPU_LIMIT:-1}
          memory: ${PREST_MEMORY_LIMIT:-1G}
        reservations:
          cpus: ${PREST_CPU_RESERVATION:-0.5}
          memory: ${PREST_MEMORY_RESERVATION:-512M}
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # ---------------------------------------------------------------------------
  # 4. Traefik: API Gateway and Load Balancer
  # ---------------------------------------------------------------------------
  traefik:
    image: traefik:v3.1
    container_name: agentstack-traefik-prod
    restart: unless-stopped
    command:
      - "--api.dashboard=true"
      - "--api.insecure=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.websecure.http.tls=true"
      - "--entrypoints.websecure.http.tls.options=default"
      - "--certificatesresolvers.myresolver.acme.tlschallenge=true"
      - "--certificatesresolvers.myresolver.acme.email=${LETSENCRYPT_EMAIL}"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
      - "--accesslog=true"
      - "--accesslog.filepath=/var/log/traefik/access.log"
      - "--log.level=${TRAEFIK_LOG_LEVEL:-INFO}"
      - "--metrics.prometheus=true"
      - "--metrics.prometheus.addEntryPointsLabels=true"
      - "--metrics.prometheus.addServicesLabels=true"
      - "--tracing.jaeger=true"
      - "--tracing.jaeger.samplingServerURL=http://jaeger:14268/api/sampling"
      - "--tracing.jaeger.localAgentHostPort=jaeger:6831"
      - "--tracing.jaeger.gen128Bit=true"
      - "--ping=true"
      - "--global.checkNewVersion=false"
      - "--global.sendAnonymousUsageStats=false"
    environment:
      LETSENCRYPT_EMAIL: ${LETSENCRYPT_EMAIL}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./config/traefik/dynamic:/etc/traefik/dynamic:ro
      - letsencrypt_data:/letsencrypt
      - traefik_logs:/var/log/traefik
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Dashboard (expose only internally in production)
    networks:
      - agentstack-frontend
      - agentstack-monitoring
    healthcheck:
      test: ["CMD-SHELL", "traefik healthcheck --ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: ${TRAEFIK_CPU_LIMIT:-0.5}
          memory: ${TRAEFIK_MEMORY_LIMIT:-512M}
        reservations:
          cpus: ${TRAEFIK_CPU_RESERVATION:-0.25}
          memory: ${TRAEFIK_MEMORY_RESERVATION:-256M}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.agentstack.local`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls.certresolver=myresolver"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.middlewares=traefik-auth"
      - "traefik.http.middlewares.traefik-auth.basicauth.users=${TRAEFIK_BASIC_AUTH_USERS}"

  # ---------------------------------------------------------------------------
  # 5. Prometheus: Metrics Collection
  # ---------------------------------------------------------------------------
  prometheus:
    image: prom/prometheus:v2.53.0
    container_name: agentstack-prometheus-prod
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=${PROMETHEUS_RETENTION:-30d}'
      - '--storage.tsdb.retention.size=${PROMETHEUS_RETENTION_SIZE:-10GB}'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
      - '--web.external-url=https://prometheus.agentstack.local'
    volumes:
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./config/prometheus/rules:/etc/prometheus/rules:ro
      - prometheus_data:/prometheus
    networks:
      - agentstack-monitoring
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9090/-/healthy || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: ${PROMETHEUS_CPU_LIMIT:-1}
          memory: ${PROMETHEUS_MEMORY_LIMIT:-2G}
        reservations:
          cpus: ${PROMETHEUS_CPU_RESERVATION:-0.5}
          memory: ${PROMETHEUS_MEMORY_RESERVATION:-1G}

  # ---------------------------------------------------------------------------
  # 6. Grafana: Visualization and Dashboards
  # ---------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:11.2.0
    container_name: agentstack-grafana-prod
    restart: unless-stopped
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
      GF_INSTALL_PLUGINS: ${GRAFANA_PLUGINS:-grafana-piechart-panel,grafana-worldmap-panel}
      GF_SERVER_DOMAIN: grafana.agentstack.local
      GF_SERVER_ROOT_URL: https://grafana.agentstack.local
      GF_SERVER_ENABLE_GZIP: ${GRAFANA_ENABLE_GZIP:-true}
      GF_SERVER_CERT_FILE: /opt/agentstack/grafana/ssl/server.crt
      GF_SERVER_CERT_KEY: /opt/agentstack/grafana/ssl/server.key
      GF_DATABASE_TYPE: postgres
      GF_DATABASE_HOST: postgres:5432
      GF_DATABASE_NAME: grafana
      GF_DATABASE_USER: ${POSTGRES_USER:-postgres}
      GF_DATABASE_PASSWORD: ${POSTGRES_PASSWORD}
      GF_LOG_LEVEL: ${GRAFANA_LOG_LEVEL:-info}
      GF_LOG_MODE: ${GRAFANA_LOG_MODE:-console,file}
      GF_PATHS_LOGS: /var/log/grafana
    volumes:
      - grafana_data:/var/lib/grafana
      - grafana_logs:/var/log/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./config/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - postgres_ssl:/opt/agentstack/grafana/ssl:ro
    networks:
      - agentstack-monitoring
      - agentstack-backend
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: ${GRAFANA_CPU_LIMIT:-0.5}
          memory: ${GRAFANA_MEMORY_LIMIT:-1G}
        reservations:
          cpus: ${GRAFANA_CPU_RESERVATION:-0.25}
          memory: ${GRAFANA_MEMORY_RESERVATION:-512M}

  # ---------------------------------------------------------------------------
  # 7. Jaeger: Distributed Tracing
  # ---------------------------------------------------------------------------
  jaeger:
    image: jaegertracing/all-in-one:1.58
    container_name: agentstack-jaeger-prod
    restart: unless-stopped
    environment:
      COLLECTOR_OTLP_ENABLED: ${JAEGER_OTLP_ENABLED:-true}
      SPAN_STORAGE_TYPE: ${JAEGER_STORAGE_TYPE:-memory}
      JAEGER_UI_CONFIG: /etc/jaeger/ui.json
    volumes:
      - ./config/jaeger/ui.json:/etc/jaeger/ui.json:ro
    networks:
      - agentstack-monitoring
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:14269/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: ${JAEGER_CPU_LIMIT:-0.5}
          memory: ${JAEGER_MEMORY_LIMIT:-1G}
        reservations:
          cpus: ${JAEGER_CPU_RESERVATION:-0.25}
          memory: ${JAEGER_MEMORY_RESERVATION:-512M}

  # ---------------------------------------------------------------------------
  # 8. Redis: Caching and Session Storage
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7.2-alpine
    container_name: agentstack-redis-prod
    restart: unless-stopped
    command:
      - redis-server
      - --appendonly ${REDIS_APPENDONLY:-yes}
      - --appendfsync ${REDIS_APPENDFSYNC:-everysec}
      - --maxmemory ${REDIS_MAXMEMORY:-512mb}
      - --maxmemory-policy ${REDIS_MAXMEMORY_POLICY:-allkeys-lru}
      - --save ${REDIS_SAVE_CONFIG:-900 1 300 10 60 10000}
      - --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
      - ./config/redis/redis.conf:/etc/redis/redis.conf:ro
    networks:
      - agentstack-backend
    healthcheck:
      test: ["CMD-SHELL", "redis-cli --raw incr ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: ${REDIS_CPU_LIMIT:-0.5}
          memory: ${REDIS_MEMORY_LIMIT:-512M}
        reservations:
          cpus: ${REDIS_CPU_RESERVATION:-0.25}
          memory: ${REDIS_MEMORY_RESERVATION:-256M}

  # ---------------------------------------------------------------------------
  # 9. PostgreSQL Exporter: Database Metrics
  # ---------------------------------------------------------------------------
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:v0.15.0
    container_name: agentstack-postgres-exporter-prod
    restart: unless-stopped
    environment:
      DATA_SOURCE_NAME: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-agentstack}?sslmode=${POSTGRES_SSL:-require}
      PG_EXPORTER_DISABLE_DEFAULT_METRICS: ${POSTGRES_EXPORTER_DISABLE_DEFAULT_METRICS:-false}
      PG_EXPORTER_AUTO_DISCOVER_DATABASES: ${POSTGRES_EXPORTER_AUTO_DISCOVER_DATABASES:-true}
      PG_EXPORTER_EXCLUDE_DATABASES: ${POSTGRES_EXPORTER_EXCLUDE_DATABASES:-template0,template1}
      PG_EXPORTER_CONSTANT_LABELS: ${PG_EXPORTER_CONSTANT_LABELS:-cluster=agentstack,service=postgres}
    networks:
      - agentstack-backend
      - agentstack-monitoring
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9187/metrics || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: ${POSTGRES_EXPORTER_CPU_LIMIT:-0.25}
          memory: ${POSTGRES_EXPORTER_MEMORY_LIMIT:-128M}
        reservations:
          cpus: ${POSTGRES_EXPORTER_CPU_RESERVATION:-0.1}
          memory: ${POSTGRES_EXPORTER_MEMORY_RESERVATION:-64M}

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${POSTGRES_DATA_PATH:-/opt/agentstack/postgres/data}

  postgres_ssl:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${POSTGRES_SSL_PATH:-/opt/agentstack/postgres/ssl}

  prest_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PREST_LOGS_PATH:-/opt/agentstack/prest/logs}

  prometheus_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PROMETHEUS_DATA_PATH:-/opt/agentstack/prometheus/data}

  grafana_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${GRAFANA_DATA_PATH:-/opt/agentstack/grafana/data}

  grafana_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${GRAFANA_LOGS_PATH:-/opt/agentstack/grafana/logs}

  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${REDIS_DATA_PATH:-/opt/agentstack/redis/data}

  letsencrypt_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${LETSENCRYPT_DATA_PATH:-/opt/agentstack/letsencrypt}

  traefik_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${TRAEFIK_LOGS_PATH:-/opt/agentstack/traefik/logs}

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  agentstack-frontend:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: agentstack-frontend
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com.docker.network.driver.mtu: 1500

  agentstack-backend:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: agentstack-backend
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com.docker.network.driver.mtu: 1500
    internal: true  # Isolated from external network for security

  agentstack-monitoring:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: agentstack-monitoring
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"
      com.docker.network.driver.mtu: 1500

# =============================================================================
# TRAEFIK LABELS FOR EXTERNAL SERVICES
# =============================================================================
x-traefik-labels: &traefik-labels
  traefik.enable: "true"
  traefik.http.routers.prest-api.rule: "Host(`api.agentstack.local`)"
  traefik.http.routers.prest-api.entrypoints: "websecure"
  traefik.http.routers.prest-api.tls.certresolver: "myresolver"
  traefik.http.routers.prest-api.middlewares: "prest-security,prest-rate-limit"
  traefik.http.services.prest-api.loadbalancer.server.port: 3000
  traefik.http.services.prest-api.loadbalancer.healthcheck.path: "/health"
  traefik.http.services.prest-api.loadbalancer.healthcheck.interval: "30s"
  traefik.http.services.prest-api.loadbalancer.healthcheck.timeout: "10s"
  traefik.http.middlewares.prest-security.headers.stsSeconds: "31536000"
  traefik.http.middlewares.prest-security.headers.stsIncludeSubdomains: "true"
  traefik.http.middlewares.prest-security.headers.stsPreload: "true"
  traefik.http.middlewares.prest-security.headers.contentTypeNosniff: "true"
  traefik.http.middlewares.prest-security.headers.browserXssFilter: "true"
  traefik.http.middlewares.prest-security.headers.frameDeny: "true"
  traefik.http.middlewares.prest-security.headers.referrerPolicy: "strict-origin-when-cross-origin"
  traefik.http.middlewares.prest-security.headers.permissionsPolicy: "camera=(), microphone=(), geolocation=()"
  traefik.http.middlewares.prest-rate-limit.ratelimit.average: "100"
  traefik.http.middlewares.prest-rate-limit.ratelimit.burst: "200"
  traefik.http.middlewares.prest-rate-limit.ratelimit.period: "1m"

x-traefik-labels: &traefik-labels-monitoring
  traefik.enable: "true"
  traefik.http.routers.grafana.rule: "Host(`grafana.agentstack.local`)"
  traefik.http.routers.grafana.entrypoints: "websecure"
  traefik.http.routers.grafana.tls.certresolver: "myresolver"
  traefik.http.services.grafana.loadbalancer.server.port: 3000
  traefik.http.routers.jaeger.rule: "Host(`jaeger.agentstack.local`)"
  traefik.http.routers.jaeger.entrypoints: "websecure"
  traefik.http.routers.jaeger.tls.certresolver: "myresolver"
  traefik.http.services.jaeger.loadbalancer.server.port: 16686