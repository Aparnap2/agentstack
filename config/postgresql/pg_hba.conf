# =============================================================================
# AgentStack OSS - Production PostgreSQL Host-Based Authentication
# Version: 1.0.0
# Environment: Production
# =============================================================================

# TYPE  DATABASE        USER            ADDRESS                 METHOD
# -----------------------------------------------------------------------------

# Allow local connections via Unix domain socket
local   all             postgres                                peer
local   all             all                                     md5

# IPv4 local connections:
host    all             postgres        127.0.0.1/32            md5
host    all             all             127.0.0.1/32            md5

# IPv6 local connections:
host    all             postgres        ::1/128                 md5
host    all             all             ::1/128                 md5

# Allow replication connections from localhost
host    replication     postgres        127.0.0.1/32            md5
host    replication     postgres        ::1/128                 md5

# Production application connections
# AgentStack API service (Docker network)
host    agentstack      postgres        172.16.0.0/12           md5
host    all             postgres        172.16.0.0/12           md5

# pREST API service (Docker network)
host    agentstack      prest_user      172.16.0.0/12           md5

# Monitoring and observability services
host    all             monitoring      172.20.0.0/12           md5
host    postgres        postgres        172.20.0.0/12           md5

# Backup service (restricted access)
host    all             backup_user     172.24.0.0/12           md5

# SSL/TLS connections (require client certificates in production)
hostssl all             postgres        0.0.0.0/0               cert
hostssl all             all             0.0.0.0/0               md5

# Admin connections from management network (if configured)
# host    all             postgres        10.0.0.0/8              md5
# host    all             postgres        192.168.0.0/16          md5

# -----------------------------------------------------------------------------
# SECURITY NOTES:
# -----------------------------------------------------------------------------
# 1. In production, replace 'md5' with 'scram-sha-256' for better security
# 2. Consider implementing client certificate authentication (cert method)
# 3. Restrict access by specific application IP addresses when possible
# 4. Use different users for different services (principle of least privilege)
# 5. Regularly audit and review access patterns
# 6. Implement connection pooling (PgBouncer) for high-traffic deployments
# =============================================================================